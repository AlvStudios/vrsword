<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Espada en el Objeto Verde MÃ¡s Cercano</title>
    <style>
        body { margin: 0; overflow: hidden; }
        #video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        #swordCanvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 2; }
    </style>
</head>
<body>
    <video id="video" autoplay muted playsinline></video>
    <canvas id="swordCanvas"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.3.0/dist/tf.min.js"></script>
    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('swordCanvas');
        const context = canvas.getContext('2d');

        async function init() {
            await startVideo();

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            detectGreenObject();
        }

        function startVideo() {
            return new Promise((resolve, reject) => {
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                    .then(stream => {
                        video.srcObject = stream;
                        video.onloadedmetadata = () => {
                            video.play();
                            resolve();
                        };
                    })
                    .catch(err => {
                        console.error('Error accessing camera:', err);
                        reject(err);
                    });
            });
        }

        function drawSword(x, y) {
            context.clearRect(0, 0, canvas.width, canvas.height);

            const swordWidth = 20;
            const swordHeight = 80;

            context.strokeStyle = 'silver';
            context.lineWidth = 5;
            context.beginPath();
            context.moveTo(x - swordWidth / 2, y - swordHeight / 2);
            context.lineTo(x + swordWidth / 2, y - swordHeight / 2);
            context.lineTo(x + swordWidth / 2, y + swordHeight / 2);
            context.lineTo(x - swordWidth / 2, y + swordHeight / 2);
            context.closePath();
            context.stroke();
        }

        function detectGreenObject() {
            function processFrame() {
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                const frame = context.getImageData(0, 0, canvas.width, canvas.height);
                const data = frame.data;

                let minDistance = Infinity;
                let closestPoint = { x: -100, y: -100 };
                let debugPoints = [];

                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];

                    if (r < 100 && g > 150 && b < 100) { // Ajusta estos valores para detectar el verde
                        const x = (i / 4) % canvas.width;
                        const y = Math.floor((i / 4) / canvas.width);

                        debugPoints.push({ x, y });

                        const distance = Math.sqrt(Math.pow(x - canvas.width / 2, 2) + Math.pow(y - canvas.height / 2, 2));

                        if (distance < minDistance) {
                            minDistance = distance;
                            closestPoint = { x, y };
                        }
                    }
                }

                if (minDistance < Infinity) {
                    drawSword(closestPoint.x, closestPoint.y);
                } else {
                    drawSword(-100, -100); // Coloca la espada fuera de la vista si no hay objeto verde
                }

                drawDebugPoints(debugPoints);

                requestAnimationFrame(processFrame);
            }

            processFrame();
        }

        function drawDebugPoints(points) {
            context.fillStyle = 'red';
            points.forEach(point => {
                context.beginPath();
                context.arc(point.x, point.y, 5, 0, 2 * Math.PI);
                context.fill();
            });
        }

        init();
    </script>
</body>
</html>
