<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mano y Espada</title>
    <style>
        body { margin: 0; overflow: hidden; }
        #video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        #swordCanvas { position: absolute; top: 0; left: 0; pointer-events: none; }
    </style>
</head>
<body>
    <video id="video" autoplay></video>
    <canvas id="swordCanvas"></canvas>

    <!-- Incluir handtrack.js desde un CDN -->
    <script src="https://cdn.jsdelivr.net/npm/handtrackjs@0.0.9/dist/handtrack.min.js"></script>
    <script>
        // Configuración del modelo de detección
        const modelParams = {
            flipHorizontal: true,   // Espejar horizontalmente
            maxNumBoxes: 1,          // Número máximo de manos detectadas
            iouThreshold: 0.5,       // Umbral de superposición
            scoreThreshold: 0.6,     // Umbral de puntuación de confianza
        };

        let model;

        // Inicializar el modelo y la cámara
        async function init() {
            model = await handTrack.load(modelParams);
            await startVideo();
            detectHand();
        }

        // Iniciar la cámara
        function startVideo() {
            return new Promise((resolve, reject) => {
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                    .then(stream => {
                        const video = document.getElementById('video');
                        video.srcObject = stream;
                        video.onloadedmetadata = () => {
                            resizeCanvas();
                            resolve();
                        };
                    })
                    .catch(err => reject(err));
            });
        }

        // Ajustar el tamaño del canvas
        function resizeCanvas() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('swordCanvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
        }
        window.addEventListener('resize', resizeCanvas);

        // Dibujar la espada
        function drawSword(x, y) {
            const canvas = document.getElementById('swordCanvas');
            const context = canvas.getContext('2d');
            context.clearRect(0, 0, canvas.width, canvas.height);

            // Dibujar la espada en el canvas
            context.strokeStyle = 'silver';
            context.lineWidth = 5;
            context.beginPath();
            context.moveTo(x, y - 20);
            context.lineTo(x, y + 80);
            context.moveTo(x - 10, y - 10);
            context.lineTo(x + 10, y - 10);
            context.moveTo(x - 10, y + 80);
            context.lineTo(x + 10, y + 80);
            context.stroke();
        }

        // Detectar la mano
        function detectHand() {
            model.detect(document.getElementById('video')).then(predictions => {
                if (predictions.length > 0) {
                    const hand = predictions[0].bbox; // Caja delimitadora de la mano
                    const x = hand[0] + hand[2] / 2;
                    const y = hand[1] + hand[3] / 2;

                    drawSword(x, y);
                } else {
                    // Borra la espada si no se detecta mano
                    drawSword(-100, -100); // Coloca la espada fuera de la vista
                }
                requestAnimationFrame(detectHand);
            }).catch(err => {
                console.error('Error al detectar la mano:', err);
            });
        }

        init();
    </script>
</body>
</html>
