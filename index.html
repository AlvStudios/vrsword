<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mano y Espada</title>
    <style>
        body { margin: 0; overflow: hidden; }
        #video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        #swordCanvas { position: absolute; pointer-events: none; }
    </style>
</head>
<body>
    <video id="video" autoplay></video>
    <canvas id="swordCanvas"></canvas>

    <!-- Incluir handtrack.js desde un CDN -->
    <script src="https://cdn.jsdelivr.net/npm/handtrackjs@0.0.9/dist/handtrack.min.js"></script>
    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('swordCanvas');
        const context = canvas.getContext('2d');

        // Configuración del modelo de detección
        const modelParams = {
            flipHorizontal: true,   // Espejar horizontalmente
            maxNumBoxes: 1,          // Número máximo de manos detectadas
            iouThreshold: 0.5,       // Umbral de superposición
            scoreThreshold: 0.6,     // Umbral de puntuación de confianza
        };
        
        let model;

        // Inicializar el modelo y la cámara
        async function init() {
            model = await handTrack.load();
            await startVideo();
            detectHand();
        }

        // Iniciar la cámara
        function startVideo() {
            return new Promise((resolve, reject) => {
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                    .then(stream => {
                        video.srcObject = stream;
                        video.onloadedmetadata = () => resolve();
                    })
                    .catch(err => reject(err));
            });
        }

        // Ajustar el tamaño del canvas
        function resizeCanvas() {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Dibujar la espada
        function drawSword(x, y) {
            const swordLength = 100;
            const swordWidth = 10;
            
            context.clearRect(0, 0, canvas.width, canvas.height);
            
            context.strokeStyle = 'silver';
            context.lineWidth = swordWidth;
            context.beginPath();
            context.moveTo(x, y - swordLength / 2);
            context.lineTo(x, y + swordLength / 2);
            context.moveTo(x - swordWidth / 2, y - swordLength / 4);
            context.lineTo(x + swordWidth / 2, y - swordLength / 4);
            context.moveTo(x - swordWidth / 2, y + swordLength / 4);
            context.lineTo(x + swordWidth / 2, y + swordLength / 4);
            context.stroke();
        }

        // Detectar la mano
        function detectHand() {
            model.detect(video).then(predictions => {
                if (predictions.length > 0) {
                    const hand = predictions[0].bbox; // Caja delimitadora de la mano
                    const x = hand[0] + hand[2] / 2;
                    const y = hand[1] + hand[3] / 2;
                    
                    console.log(`Hand position: x=${x}, y=${y}`); // Depurar la posición
                    
                    drawSword(x, y);
                }
                requestAnimationFrame(detectHand);
            });
        }

        init();
    </script>
</body>
</html>
